name: Publish to PyPI

on:
  release:
    types: [published]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      attestations: write
    environment: pypi
    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v7

      - name: Build package
        run: uv build --no-sources

      - name: Smoke test wheel
        run: |
          WHEEL=$(ls dist/*.whl)
          SIZE=$(stat --format=%s "$WHEEL")
          if [ "$SIZE" -gt 512000 ]; then
            echo "::error::Wheel size ${SIZE} bytes exceeds 500KB limit"
            exit 1
          fi
          echo "Wheel size: ${SIZE} bytes — OK"

          CONTENTS=$(unzip -l "$WHEEL")
          if echo "$CONTENTS" | grep -q "tests/"; then
            echo "::error::Wheel contains tests/ directory"
            exit 1
          fi
          if echo "$CONTENTS" | grep -q "_bmad"; then
            echo "::error::Wheel contains _bmad files"
            exit 1
          fi
          echo "Wheel contents clean — OK"

      - name: Verify version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          TOML_VERSION=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          if [ "$TAG_VERSION" != "$TOML_VERSION" ]; then
            echo "::error::Tag version ${TAG_VERSION} does not match pyproject.toml version ${TOML_VERSION}"
            exit 1
          fi
          echo "Version ${TAG_VERSION} matches — OK"

      - name: Publish to PyPI
        run: uv publish

      - name: Attest build provenance
        uses: astral-sh/attest-action@v0.0.5
        with:
          files: dist/*

  smoke-test:
    runs-on: ubuntu-latest
    needs: [build-and-publish]
    timeout-minutes: 5
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Wait for PyPI propagation
        run: sleep 60

      - name: Install docvet from PyPI
        run: python -m pip install --no-cache-dir docvet==${{ steps.version.outputs.VERSION }}

      - name: Verify docvet --version
        run: docvet --version

      - name: Verify docvet check --help
        run: docvet check --help

  update-tags:
    runs-on: ubuntu-latest
    needs: build-and-publish
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Update floating v1 tag
        run: |
          git tag -f v1
          git push origin v1 --force
